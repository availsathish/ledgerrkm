<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RKM LOOM SPARES - Customer Ledger</title>
    <meta name="description" content="Customer Ledger Management System for RKM LOOM SPARES">
    <meta name="theme-color" content="#208FA6">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlJLTSBMT09NIFNQQVJFUyAtIEN1c3RvbWVyIExlZGdlciIsCiAgInNob3J0X25hbWUiOiAiUktNIExlZGdlciIsCiAgImRlc2NyaXB0aW9uIjogIkN1c3RvbWVyIExlZGdlciBNYW5hZ2VtZW50IFN5c3RlbSIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzIwOEZBNiIsCiAgImljb25zIjogW10KfQ==">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // CRITICAL FIX: Locks API Polyfill - Must be loaded BEFORE Supabase
        // This fixes the SecurityError: Failed to execute 'request' on 'LockManager'
        (function() {
            // Detect browser and context
            const userAgent = navigator.userAgent.toLowerCase();
            const isChrome = userAgent.includes('chrome');
            const isFirefox = userAgent.includes('firefox');
            const isSafari = userAgent.includes('safari') && !userAgent.includes('chrome');
            const isEdge = userAgent.includes('edge');
            const isSecureContext = location.protocol === 'https:' || location.hostname === 'localhost';
            
            console.log('Browser Detection:', {
                isChrome, isFirefox, isSafari, isEdge, isSecureContext,
                protocol: location.protocol
            });
            
            // Locks API Polyfill for browsers that don't support it or in sandboxed contexts
            if (!('locks' in navigator) || typeof navigator.locks.request !== 'function') {
                console.log('Applying Locks API polyfill...');
                navigator.locks = {
                    request: async function(name, options, callback) {
                        // Handle both (name, callback) and (name, options, callback) signatures
                        if (typeof options === 'function') {
                            callback = options;
                            options = {};
                        }
                        
                        try {
                            // Simple polyfill - just execute the callback immediately
                            return await callback({ 
                                name: name,
                                mode: options.mode || 'exclusive'
                            });
                        } catch (error) {
                            console.warn('Locks API polyfill error:', error);
                            throw error;
                        }
                    },
                    query: async function() {
                        // Return empty state for compatibility
                        return { held: [], pending: [] };
                    }
                };
                console.log('Locks API polyfill applied successfully');
            } else {
                console.log('Native Locks API detected and available');
            }
            
            // Additional Web API compatibility checks and polyfills
            
            // IndexedDB availability check (Supabase may use this)
            if (!('indexedDB' in window)) {
                console.warn('IndexedDB not available - some features may be limited');
            }
            
            // BroadcastChannel polyfill for older browsers
            if (!('BroadcastChannel' in window)) {
                console.log('BroadcastChannel not available - realtime features may be limited');
                window.BroadcastChannel = function(name) {
                    this.name = name;
                    this.postMessage = function(data) {
                        console.log('BroadcastChannel polyfill - message would be sent:', data);
                    };
                    this.addEventListener = function() {};
                    this.removeEventListener = function() {};
                    this.close = function() {};
                };
            }
            
            // Set up error boundary for uncaught errors
            window.addEventListener('error', function(event) {
                console.error('Global error caught:', event.error);
                if (event.error && event.error.message && event.error.message.includes('LockManager')) {
                    console.error('LockManager error detected - this should be fixed by our polyfill');
                    event.preventDefault();
                }
            });
            
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                if (event.reason && event.reason.message && event.reason.message.includes('LockManager')) {
                    console.error('LockManager promise rejection - attempting to handle gracefully');
                    event.preventDefault();
                }
            });
            
            console.log('Browser compatibility layer initialized successfully');
        })();
    </script>
    <style>
        :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
  --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
  --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
  --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
  --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
  --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
  --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
  --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for opacity control */
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
    Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
    0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
    0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Dark mode colors */
@media (prefers-color-scheme: dark) {
  :root {
    /* RGB versions for opacity control (Dark Mode) */
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    /* Background color tokens (Dark Mode) */
    --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
    --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
    --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
    --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
    --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
    --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
    --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
    --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

    /* Semantic Color Tokens (Dark Mode) */
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
      inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    /* Common style patterns - updated for dark mode */
    --focus-ring: 0 0 0 3px var(--color-focus-ring);
    --focus-outline: 2px solid var(--color-primary);
    --status-bg-opacity: 0.15;
    --status-border-opacity: 0.25;
    --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

    /* RGB versions for dark mode */
    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

/* Data attribute for manual theme switching */
[data-color-scheme="dark"] {
  /* RGB versions for opacity control (dark mode) */
  --color-gray-400-rgb: 119, 124, 124;
  --color-teal-300-rgb: 50, 184, 198;
  --color-gray-300-rgb: 167, 169, 169;
  --color-gray-200-rgb: 245, 245, 245;

  /* Colorful background palette - Dark Mode */
  --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
  --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
  --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
  --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
  --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
  --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
  --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
  --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

  /* Semantic Color Tokens (Dark Mode) */
  --color-background: var(--color-charcoal-700);
  --color-surface: var(--color-charcoal-800);
  --color-text: var(--color-gray-200);
  --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
  --color-primary: var(--color-teal-300);
  --color-primary-hover: var(--color-teal-400);
  --color-primary-active: var(--color-teal-800);
  --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
  --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
  --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
  --color-border: rgba(var(--color-gray-400-rgb), 0.3);
  --color-error: var(--color-red-400);
  --color-success: var(--color-teal-300);
  --color-warning: var(--color-orange-400);
  --color-info: var(--color-gray-300);
  --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
  --color-btn-primary-text: var(--color-slate-900);
  --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);
  --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
    inset 0 -1px 0 rgba(0, 0, 0, 0.15);
  --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
  --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

  /* Common style patterns - updated for dark mode */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for dark mode */
  --color-success-rgb: var(--color-teal-300-rgb);
  --color-error-rgb: var(--color-red-400-rgb);
  --color-warning-rgb: var(--color-orange-400-rgb);
  --color-info-rgb: var(--color-gray-300-rgb);
}

[data-color-scheme="light"] {
  /* RGB versions for opacity control (light mode) */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

  /* RGB versions for light mode */
  --color-success-rgb: var(--color-teal-500-rgb);
  --color-error-rgb: var(--color-red-500-rgb);
  --color-warning-rgb: var(--color-orange-500-rgb);
  --color-info-rgb: var(--color-slate-500-rgb);
}

/* Base styles */
html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
}

*,
*::before,
*::after {
  box-sizing: inherit;
}

/* Typography */
h1,
h2,
h3,
h4,
h5,
h6 {
  margin: 0;
  font-weight: var(--font-weight-semibold);
  line-height: var(--line-height-tight);
  color: var(--color-text);
  letter-spacing: var(--letter-spacing-tight);
}

h1 {
  font-size: var(--font-size-4xl);
}
h2 {
  font-size: var(--font-size-3xl);
}
h3 {
  font-size: var(--font-size-2xl);
}
h4 {
  font-size: var(--font-size-xl);
}
h5 {
  font-size: var(--font-size-lg);
}
h6 {
  font-size: var(--font-size-md);
}

p {
  margin: 0 0 var(--space-16) 0;
}

a {
  color: var(--color-primary);
  text-decoration: none;
  transition: color var(--duration-fast) var(--ease-standard);
}

a:hover {
  color: var(--color-primary-hover);
}

code,
pre {
  font-family: var(--font-family-mono);
  font-size: calc(var(--font-size-base) * 0.95);
  background-color: var(--color-secondary);
  border-radius: var(--radius-sm);
}

code {
  padding: var(--space-1) var(--space-4);
}

pre {
  padding: var(--space-16);
  margin: var(--space-16) 0;
  overflow: auto;
  border: 1px solid var(--color-border);
}

pre code {
  background: none;
  padding: 0;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-base);
  font-size: var(--font-size-base);
  font-weight: 500;
  line-height: 1.5;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border: none;
  text-decoration: none;
  position: relative;
}

.btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.btn--primary {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.btn--primary:hover {
  background: var(--color-primary-hover);
}

.btn--primary:active {
  background: var(--color-primary-active);
}

.btn--secondary {
  background: var(--color-secondary);
  color: var(--color-text);
}

.btn--secondary:hover {
  background: var(--color-secondary-hover);
}

.btn--secondary:active {
  background: var(--color-secondary-active);
}

.btn--outline {
  background: transparent;
  border: 1px solid var(--color-border);
  color: var(--color-text);
}

.btn--outline:hover {
  background: var(--color-secondary);
}

.btn--sm {
  padding: var(--space-4) var(--space-12);
  font-size: var(--font-size-sm);
  border-radius: var(--radius-sm);
}

.btn--lg {
  padding: var(--space-10) var(--space-20);
  font-size: var(--font-size-lg);
  border-radius: var(--radius-md);
}

.btn--full-width {
  width: 100%;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Form elements */
.form-control {
  display: block;
  width: 100%;
  padding: var(--space-8) var(--space-12);
  font-size: var(--font-size-md);
  line-height: 1.5;
  color: var(--color-text);
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  transition: border-color var(--duration-fast) var(--ease-standard),
    box-shadow var(--duration-fast) var(--ease-standard);
}

textarea.form-control {
  font-family: var(--font-family-base);
  font-size: var(--font-size-base);
}

select.form-control {
  padding: var(--space-8) var(--space-12);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: var(--select-caret-light);
  background-repeat: no-repeat;
  background-position: right var(--space-12) center;
  background-size: 16px;
  padding-right: var(--space-32);
}

/* Add a dark mode specific caret */
@media (prefers-color-scheme: dark) {
  select.form-control {
    background-image: var(--select-caret-dark);
  }
}

/* Also handle data-color-scheme */
[data-color-scheme="dark"] select.form-control {
  background-image: var(--select-caret-dark);
}

[data-color-scheme="light"] select.form-control {
  background-image: var(--select-caret-light);
}

.form-control:focus {
  border-color: var(--color-primary);
  outline: var(--focus-outline);
}

.form-label {
  display: block;
  margin-bottom: var(--space-8);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
}

.form-group {
  margin-bottom: var(--space-16);
}

/* Card component */
.card {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  transition: box-shadow var(--duration-normal) var(--ease-standard);
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card__body {
  padding: var(--space-16);
}

.card__header,
.card__footer {
  padding: var(--space-16);
  border-bottom: 1px solid var(--color-card-border-inner);
}

/* Status indicators - simplified with CSS variables */
.status {
  display: inline-flex;
  align-items: center;
  padding: var(--space-6) var(--space-12);
  border-radius: var(--radius-full);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
}

.status--success {
  background-color: rgba(
    var(--color-success-rgb, 33, 128, 141),
    var(--status-bg-opacity)
  );
  color: var(--color-success);
  border: 1px solid
    rgba(var(--color-success-rgb, 33, 128, 141), var(--status-border-opacity));
}

.status--error {
  background-color: rgba(
    var(--color-error-rgb, 192, 21, 47),
    var(--status-bg-opacity)
  );
  color: var(--color-error);
  border: 1px solid
    rgba(var(--color-error-rgb, 192, 21, 47), var(--status-border-opacity));
}

.status--warning {
  background-color: rgba(
    var(--color-warning-rgb, 168, 75, 47),
    var(--status-bg-opacity)
  );
  color: var(--color-warning);
  border: 1px solid
    rgba(var(--color-warning-rgb, 168, 75, 47), var(--status-border-opacity));
}

.status--info {
  background-color: rgba(
    var(--color-info-rgb, 98, 108, 113),
    var(--status-bg-opacity)
  );
  color: var(--color-info);
  border: 1px solid
    rgba(var(--color-info-rgb, 98, 108, 113), var(--status-border-opacity));
}

/* Container layout */
.container {
  width: 100%;
  margin-right: auto;
  margin-left: auto;
  padding-right: var(--space-16);
  padding-left: var(--space-16);
}

@media (min-width: 640px) {
  .container {
    max-width: var(--container-sm);
  }
}
@media (min-width: 768px) {
  .container {
    max-width: var(--container-md);
  }
}
@media (min-width: 1024px) {
  .container {
    max-width: var(--container-lg);
  }
}
@media (min-width: 1280px) {
  .container {
    max-width: var(--container-xl);
  }
}

/* Utility classes */
.flex {
  display: flex;
}
.flex-col {
  flex-direction: column;
}
.items-center {
  align-items: center;
}
.justify-center {
  justify-content: center;
}
.justify-between {
  justify-content: space-between;
}
.gap-4 {
  gap: var(--space-4);
}
.gap-8 {
  gap: var(--space-8);
}
.gap-16 {
  gap: var(--space-16);
}

.m-0 {
  margin: 0;
}
.mt-8 {
  margin-top: var(--space-8);
}
.mb-8 {
  margin-bottom: var(--space-8);
}
.mx-8 {
  margin-left: var(--space-8);
  margin-right: var(--space-8);
}
.my-8 {
  margin-top: var(--space-8);
  margin-bottom: var(--space-8);
}

.p-0 {
  padding: 0;
}
.py-8 {
  padding-top: var(--space-8);
  padding-bottom: var(--space-8);
}
.px-8 {
  padding-left: var(--space-8);
  padding-right: var(--space-8);
}
.py-16 {
  padding-top: var(--space-16);
  padding-bottom: var(--space-16);
}
.px-16 {
  padding-left: var(--space-16);
  padding-right: var(--space-16);
}

.block {
  display: block;
}
.hidden {
  display: none;
}

/* Accessibility */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

:focus-visible {
  outline: var(--focus-outline);
  outline-offset: 2px;
}

/* Dark mode specifics */
[data-color-scheme="dark"] .btn--outline {
  border: 1px solid var(--color-border-secondary);
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
    format('woff2');
}

        /* Custom App Styles */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            padding: var(--space-12) var(--space-16);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            color: var(--color-btn-primary-text);
            font-size: var(--font-size-xl);
            margin: 0;
        }
        
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--color-btn-primary-text);
            padding: var(--space-6) var(--space-12);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-sm);
        }
        
        .main-content {
            flex: 1;
            padding: var(--space-16);
        }
        
        .bottom-nav {
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            padding: var(--space-8) 0;
            display: flex;
            justify-content: space-around;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-8);
            cursor: pointer;
            border-radius: var(--radius-base);
            transition: background-color var(--duration-fast);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }
        
        .nav-item.active {
            color: var(--color-primary);
            background: var(--color-bg-1);
        }
        
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: var(--space-4);
            fill: currentColor;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }
        
        .metric-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            text-align: center;
        }
        
        .metric-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            display: block;
            margin-bottom: var(--space-4);
        }
        
        .metric-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
        
        .customer-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
        }
        
        .customer-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            cursor: pointer;
            transition: all var(--duration-normal);
        }
        
        .customer-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }
        
        .customer-name {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-4);
        }
        
        .customer-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
        
        .balance {
            font-weight: var(--font-weight-medium);
        }
        
        .balance.positive {
            color: var(--color-success);
        }
        
        .balance.negative {
            color: var(--color-error);
        }
        
        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
        }
        
        .transaction-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-8);
        }
        
        .transaction-amount {
            font-weight: var(--font-weight-bold);
        }
        
        .transaction-amount.positive {
            color: var(--color-success);
        }
        
        .transaction-amount.negative {
            color: var(--color-error);
        }
        
        .search-box {
            margin-bottom: var(--space-16);
        }
        
        .add-btn {
            position: fixed;
            bottom: 80px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            border: none;
            font-size: 24px;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--space-16);
        }
        
        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: var(--space-16);
        }
        
        .modal-footer {
            padding: var(--space-16);
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: var(--space-12);
            justify-content: flex-end;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
        }
        
        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .outstanding-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }
        
        .summary-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            text-align: center;
        }
        
        .summary-amount {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            display: block;
            margin-bottom: var(--space-4);
        }
        
        .receivable {
            color: var(--color-success);
        }
        
        .payable {
            color: var(--color-error);
        }
        
        .report-filters {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            margin-bottom: var(--space-16);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-16);
        }
        
        .invoice-preview {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin: var(--space-16) 0;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: var(--space-24);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: var(--space-16);
        }
        
        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-24);
            margin-bottom: var(--space-24);
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-16);
        }
        
        .invoice-table th,
        .invoice-table td {
            padding: var(--space-8) var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        
        .invoice-table th {
            background: var(--color-bg-1);
            font-weight: var(--font-weight-semibold);
        }
        
        .invoice-total {
            text-align: right;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }
        
        .loading {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }
        
        .btn-group {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }
        
        .btn-group .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .alert {
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            border-left: 4px solid;
        }
        
        .alert--success {
            background: var(--color-bg-3);
            border-color: var(--color-success);
            color: var(--color-success);
        }
        
        .alert--error {
            background: var(--color-bg-4);
            border-color: var(--color-error);
            color: var(--color-error);
        }
        
        .alert--warning {
            background: var(--color-bg-2);
            border-color: var(--color-warning);
            color: var(--color-warning);
        }
        
        .sync-status {
            position: fixed;
            top: 60px;
            right: 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-xs);
            z-index: 90;
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
        }
        
        .sync-indicator.syncing {
            background: var(--color-warning);
            animation: pulse 1s infinite;
        }
        
        .sync-indicator.error {
            background: var(--color-error);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .help-text {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
            font-style: italic;
        }
        
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }
        
        .config-status {
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .setup-section {
            margin-top: var(--space-24);
        }
        
        .setup-section h4 {
            margin-bottom: var(--space-12);
        }
        
        .setup-section ol {
            margin: 0;
            padding-left: var(--space-16);
        }
        
        .setup-section ol li {
            margin-bottom: var(--space-8);
        }

        @media print {
            .header, .bottom-nav, .add-btn, .modal {
                display: none !important;
            }
            
            .main-content {
                padding: 0;
            }
            
            .invoice-preview {
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>RKM LOOM SPARES</h1>
            <div class="flex items-center gap-8">
                <button class="btn btn--sm btn--secondary" onclick="switchScreen('settings')" title="Database Settings">
                    ‚öôÔ∏è
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
            </div>
        </header>
        
        <!-- Sync Status Indicator -->
        <div class="sync-status" id="sync-status">
            <div class="sync-indicator" id="sync-indicator"></div>
            <span id="sync-text">Connected</span>
        </div>
        
        <main class="main-content">
            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen active">
                <div class="dashboard-metrics">
                    <div class="metric-card">
                        <span class="metric-value" id="total-customers">0</span>
                        <span class="metric-label">Total Customers</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="total-outstanding">‚Çπ0</span>
                        <span class="metric-label">Net Outstanding</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="monthly-sales">‚Çπ0</span>
                        <span class="metric-label">Monthly Sales</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="recent-transactions">0</span>
                        <span class="metric-label">Recent Transactions</span>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card__body">
                        <h3>Recent Activity</h3>
                        <div id="recent-activity"></div>
                    </div>
                </div>
            </div>
            
            <!-- Customers Screen -->
            <div id="customers-screen" class="screen">
                <div class="search-box">
                    <input type="text" class="form-control" placeholder="Search customers..." id="customer-search">
                </div>
                <div id="customer-list" class="customer-list"></div>
                <button class="add-btn" onclick="openCustomerModal()">+</button>
            </div>
            
            <!-- Transactions Screen -->
            <div id="transactions-screen" class="screen">
                <div class="search-box">
                    <input type="text" class="form-control" placeholder="Search transactions..." id="transaction-search">
                </div>
                <div id="transaction-list" class="transaction-list"></div>
                <button class="add-btn" onclick="openTransactionModal()">+</button>
            </div>
            
            <!-- Outstanding Screen -->
            <div id="outstanding-screen" class="screen">
                <div class="outstanding-summary">
                    <div class="summary-card">
                        <span class="summary-amount receivable" id="total-receivable">‚Çπ0</span>
                        <span class="metric-label">Receivable (We get)</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-amount payable" id="total-payable">‚Çπ0</span>
                        <span class="metric-label">Payable (We owe)</span>
                    </div>
                </div>
                <div id="outstanding-list" class="customer-list"></div>
            </div>
            
            <!-- Reports Screen -->
            <div id="reports-screen" class="screen">
                <div class="report-filters">
                    <h3>Generate Reports</h3>
                    <div class="filter-row">
                        <div class="form-group">
                            <label class="form-label">Report Type</label>
                            <select class="form-control" id="report-type">
                                <option value="customer-ledger">Customer Ledger</option>
                                <option value="outstanding-summary">Outstanding Summary</option>
                                <option value="monthly-sales">Monthly Sales</option>
                                <option value="transaction-history">Transaction History</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" id="report-from-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" id="report-to-date">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn--primary" onclick="generateReport()">Generate Report</button>
                        <button class="btn btn--secondary" onclick="exportReport()">Export CSV</button>
                    </div>
                </div>
                <div id="report-content"></div>
            </div>
            
            <!-- Settings Screen -->
            <div id="settings-screen" class="screen">
                <div class="card">
                    <div class="card__header">
                        <h3>Database Configuration</h3>
                    </div>
                    <div class="card__body">
                        <div id="connection-status" class="alert alert--info">
                            <div class="flex items-center gap-8">
                                <div class="sync-indicator" id="config-status-indicator"></div>
                                <span id="config-status-text">Checking connection...</span>
                            </div>
                        </div>
                        
                        <form id="supabase-config-form">
                            <div class="form-group">
                                <label class="form-label">Supabase URL *</label>
                                <input type="url" class="form-control" id="supabase-url" 
                                       placeholder="https://yourproject.supabase.co" 
                                       pattern="https://.*\.supabase\.co" 
                                       title="Please enter a valid Supabase URL" required>
                                <div class="help-text">Format: https://yourproject.supabase.co</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">API Key (anon public) *</label>
                                <input type="text" class="form-control" id="supabase-key" 
                                       placeholder="eyJ..." required>
                                <div class="help-text">Found in Supabase Dashboard &gt; Settings &gt; API &gt; anon public key</div>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn--primary" onclick="testConnection()" id="test-btn">
                                    Test Connection
                                </button>
                                <button type="button" class="btn btn--secondary" onclick="saveConfiguration()" id="save-btn">
                                    Save Configuration
                                </button>
                                <button type="button" class="btn btn--outline" onclick="clearConfiguration()">
                                    Clear Config
                                </button>
                            </div>
                        </form>
                        
                        <div class="card" style="margin-top: var(--space-24); background: var(--color-bg-1);">
                            <div class="card__body">
                                <h4>Setup Instructions</h4>
                                <ol style="margin: 0; padding-left: var(--space-16);">
                                    <li>Go to <a href="https://supabase.com" target="_blank">supabase.com</a> and create an account</li>
                                    <li>Create a new project named 'RKM-LOOM-SPARES'</li>
                                    <li>Go to Settings &gt; API and copy your project URL and anon key</li>
                                    <li>Paste them above and click 'Test Connection'</li>
                                    <li>If successful, click 'Save Configuration'</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: var(--space-16); background: var(--color-bg-2);">
                            <div class="card__body">
                                <h4>Browser Compatibility</h4>
                                <div style="margin-bottom: var(--space-12);">
                                    <strong>Current Browser Status:</strong>
                                </div>
                                <div id="browser-status" style="font-family: var(--font-family-mono); font-size: var(--font-size-sm);"></div>
                                <div style="margin-top: var(--space-12);">
                                    <strong>Recommended Browsers:</strong>
                                    <ul style="margin: var(--space-8) 0; padding-left: var(--space-16);">
                                        <li><strong>Chrome 69+:</strong> Full support</li>
                                        <li><strong>Edge 79+:</strong> Full support</li>
                                        <li><strong>Firefox:</strong> May need polyfill (provided automatically)</li>
                                        <li><strong>Safari:</strong> Limited support, polyfill applied</li>
                                    </ul>
                                </div>
                                <div style="margin-top: var(--space-12);">
                                    <button class="btn btn--sm btn--secondary" onclick="runBrowserCompatibilityTest()">Test Browser Compatibility</button>
                                    <button class="btn btn--sm btn--outline" onclick="switchToDemo()">Try Demo Mode</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: var(--space-16); background: var(--color-bg-2);">
                            <div class="card__body">
                                <h4>Database Setup</h4>
                                <p>After connecting, create these tables in your Supabase SQL editor:</p>
                                <button class="btn btn--sm btn--secondary" onclick="showDatabaseSetup()">
                                    View SQL Commands
                                </button>
                                <button class="btn btn--sm btn--primary" onclick="autoSetupDatabase()" id="auto-setup-btn" style="display: none;">
                                    Auto-Setup Database
                                </button>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: var(--space-16);">
                            <div class="card__body">
                                <h4>Data Management</h4>
                                <div class="alert alert--info" style="margin-bottom: var(--space-12);">
                                    <strong>Note:</strong> This app runs in a sandboxed environment. Configuration is saved for the current session only.
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn--secondary" onclick="exportData()">Export Data</button>
                                    <button class="btn btn--secondary" onclick="importData()">Import Data</button>
                                    <button class="btn btn--outline" onclick="switchToDemo()">Demo Mode</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchScreen('dashboard')">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                </svg>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchScreen('customers')">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span>Customers</span>
            </div>
            <div class="nav-item" onclick="switchScreen('transactions')">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span>Transactions</span>
            </div>
            <div class="nav-item" onclick="switchScreen('outstanding')">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                </svg>
                <span>Outstanding</span>
            </div>
            <div class="nav-item" onclick="switchScreen('reports')">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                </svg>
                <span>Reports</span>
            </div>
            <div class="nav-item" onclick="switchScreen('settings')">
                <svg class="nav-icon" viewBox="0 0 24 24">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                <span>Settings</span>
            </div>
        </nav>
    </div>
    
    <!-- Customer Modal -->
    <div id="customer-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customer-modal-title">Add Customer</h3>
                <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <div class="form-group">
                        <label class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" id="customer-name" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="customer-phone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="customer-email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="customer-address" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">GST Number</label>
                            <input type="text" class="form-control" id="customer-gst">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-control" id="customer-category">
                                <option value="Regular">Regular</option>
                                <option value="Premium">Premium</option>
                                <option value="Wholesale">Wholesale</option>
                                <option value="Retail">Retail</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Credit Limit (‚Çπ)</label>
                        <input type="number" class="form-control" id="customer-credit-limit" min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" onclick="closeCustomerModal()">Cancel</button>
                <button type="submit" class="btn btn--primary" onclick="saveCustomer()">Save Customer</button>
            </div>
        </div>
    </div>
    
    <!-- Transaction Modal -->
    <div id="transaction-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Transaction</h3>
                <button class="close-btn" onclick="closeTransactionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    <div class="form-group">
                        <label class="form-label">Customer *</label>
                        <select class="form-control" id="transaction-customer" required>
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Transaction Type *</label>
                            <select class="form-control" id="transaction-type" required>
                                <option value="Sale">Sale (+)</option>
                                <option value="Payment Received">Payment Received (-)</option>
                                <option value="Credit Note">Credit Note (-)</option>
                                <option value="Debit Note">Debit Note (+)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount (‚Çπ) *</label>
                            <input type="number" class="form-control" id="transaction-amount" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control" id="transaction-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="transaction-invoice">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" id="transaction-description" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" onclick="closeTransactionModal()">Cancel</button>
                <button type="submit" class="btn btn--primary" onclick="saveTransaction()">Save Transaction</button>
            </div>
        </div>
    </div>
    
    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Invoice</h3>
                <button class="close-btn" onclick="closeInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invoice-preview" id="invoice-preview">
                    <!-- Invoice content will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" onclick="closeInvoiceModal()">Close</button>
                <button type="button" class="btn btn--primary" onclick="printInvoice()">Print Invoice</button>
            </div>
        </div>
    </div>
    
    <!-- Database Setup Modal -->
    <div id="setup-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Database Setup Instructions</h3>
                <button class="close-btn" onclick="closeSetupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert--info">
                    <strong>Manual Database Setup Required</strong><br>
                    Copy and run these SQL commands in your Supabase SQL editor.
                </div>
                
                <h4>Step 1: Create Customers Table</h4>
                <pre><code>CREATE TABLE customers (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  company_name TEXT NOT NULL,
  contact_person TEXT,
  phone TEXT,
  email TEXT,
  address TEXT,
  gst_number TEXT,
  category TEXT DEFAULT 'Regular',
  credit_limit NUMERIC DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);</code></pre>
                
                <h4>Step 2: Create Transactions Table</h4>
                <pre><code>CREATE TABLE transactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  type TEXT NOT NULL,
  amount NUMERIC NOT NULL,
  description TEXT NOT NULL,
  invoice_number TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);</code></pre>
                
                <h4>Step 3: Enable Security (Optional)</h4>
                <pre><code>ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- Allow all operations for all users (adjust as needed)
CREATE POLICY "Enable all operations" ON customers FOR ALL USING (true);
CREATE POLICY "Enable all operations" ON transactions FOR ALL USING (true);</code></pre>
                
                <h4>Step 4: Enable Realtime (Optional)</h4>
                <pre><code>ALTER PUBLICATION supabase_realtime ADD TABLE customers;
ALTER PUBLICATION supabase_realtime ADD TABLE transactions;</code></pre>
                
                <div class="alert alert--success" style="margin-top: var(--space-16);">
                    <strong>Next Step:</strong> After running these commands, go to Settings and test your connection!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn--primary" onclick="closeSetupModal(); switchScreen('settings');">Go to Settings</button>
                <button type="button" class="btn btn--secondary" onclick="closeSetupModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration - stored in memory (no localStorage due to sandbox restrictions)
        let SUPABASE_URL = '';
        let SUPABASE_ANON_KEY = '';
        let supabaseConfig = null;
        
        // Load configuration from memory
        function loadSupabaseConfig() {
            if (supabaseConfig) {
                SUPABASE_URL = supabaseConfig.url || '';
                SUPABASE_ANON_KEY = supabaseConfig.key || '';
                return !!SUPABASE_URL && !!SUPABASE_ANON_KEY;
            }
            return false;
        }
        
        // Save configuration to memory
        function saveSupabaseConfig(url, key) {
            try {
                supabaseConfig = { url, key };
                SUPABASE_URL = url;
                SUPABASE_ANON_KEY = key;
                return true;
            } catch (error) {
                console.error('Error saving Supabase config:', error);
                showAlert('Error saving configuration: ' + error.message, 'error');
                return false;
            }
        }
        
        // Initialize Supabase client with enhanced error handling
        let supabase;
        let isOnline = navigator.onLine;
        let syncStatus = 'connected';
        
        // Browser compatibility info
        const browserInfo = {
            userAgent: navigator.userAgent,
            isSecureContext: location.protocol === 'https:' || location.hostname === 'localhost',
            hasLocks: 'locks' in navigator,
            hasIndexedDB: 'indexedDB' in window,
            hasBroadcastChannel: 'BroadcastChannel' in window
        };
        
        console.log('Browser compatibility check:', browserInfo);
        
        // Application State - Now using Supabase
        let appData = {
            customers: [],
            transactions: [],
            company: {
                name: 'RKM LOOM SPARES',
                address: 'Palladam, Tamil Nadu, India',
                phone: '+91-XXXXXXXXXX',
                email: 'info@rkmloomspares.com',
                gst_number: '33XXXXXXXXXXXXXXX'
            }
        };
        
        // Sample data for demo (will be inserted into Supabase)
        const sampleData = {
            customers: [
                {
                    company_name: 'Coimbatore Textiles Ltd',
                    contact_person: 'Ramesh Kumar',
                    phone: '+91-9876543210',
                    email: 'accounts@coimbatoretextiles.com',
                    address: '123 Industrial Area, Coimbatore, Tamil Nadu',
                    gst_number: '33AACC1234567Z1Z',
                    category: 'Premium',
                    credit_limit: 500000
                },
                {
                    company_name: 'Chennai Mills Pvt Ltd',
                    contact_person: 'Priya Sharma',
                    phone: '+91-9876543211',
                    email: 'purchase@chennaimilIs.com',
                    address: '456 Textile Complex, Chennai, Tamil Nadu',
                    gst_number: '33BBCC5678901Z2Z',
                    category: 'Regular',
                    credit_limit: 300000
                },
                {
                    company_name: 'Tirupur Looms',
                    contact_person: 'Suresh Babu',
                    phone: '+91-9876543212',
                    email: 'info@tirupurlooms.com',
                    address: '789 Loom Street, Tirupur, Tamil Nadu',
                    gst_number: '33CCCC9012345Z3Z',
                    category: 'Wholesale',
                    credit_limit: 200000
                }
            ],
            transactions: [
                {
                    date: '2024-10-15',
                    type: 'Sale',
                    amount: 45000,
                    description: 'Picanol Air Jet Nozzle - Part No: PIC-001',
                    invoice_number: 'INV-2024-001'
                },
                {
                    date: '2024-10-14',
                    type: 'Payment Received',
                    amount: -30000,
                    description: 'Payment against invoice INV-2024-002',
                    invoice_number: ''
                },
                {
                    date: '2024-10-13',
                    type: 'Sale',
                    amount: 78000,
                    description: 'Toyota Airjet Loom Reed - Model 810',
                    invoice_number: 'INV-2024-003'
                }
            ]
        };
        
        let currentEditingCustomer = null;
        let currentScreen = 'dashboard';
        
        // Supabase Functions with Enhanced Error Handling
        async function initializeSupabase() {
            try {
                console.log('Starting Supabase initialization...');
                
                // Check browser compatibility first
                if (!browserInfo.isSecureContext) {
                    console.warn('Not in secure context - some features may be limited');
                }
                
                // Load configuration from memory
                const hasConfig = loadSupabaseConfig();
                
                if (!hasConfig || !SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    console.log('No valid Supabase configuration found');
                    updateSyncStatus('error');
                    document.getElementById('sync-text').textContent = 'Not Configured';
                    // Don't show modal automatically, let user navigate to settings
                    return;
                }
                
                // Validate URL format before creating client
                if (!SUPABASE_URL.match(/^https:\/\/.*\.supabase\.co$/)) {
                    throw new Error('Invalid Supabase URL format');
                }
                
                console.log('Creating Supabase client with enhanced error handling...');
                
                // Create Supabase client with retry mechanism
                let clientCreated = false;
                let lastError = null;
                
                for (let attempt = 1; attempt <= 3; attempt++) {
                    try {
                        console.log(`Supabase client creation attempt ${attempt}/3`);
                        
                        // Create client with specific options to avoid problematic features
                        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                            auth: {
                                persistSession: false, // Avoid localStorage issues in sandbox
                                autoRefreshToken: false // Reduce complexity
                            },
                            realtime: {
                                params: {
                                    eventsPerSecond: 10
                                }
                            },
                            global: {
                                headers: {
                                    'X-Client-Info': 'rkm-loom-spares-ledger'
                                }
                            }
                        });
                        
                        clientCreated = true;
                        console.log('Supabase client created successfully');
                        break;
                        
                    } catch (error) {
                        lastError = error;
                        console.warn(`Supabase client creation attempt ${attempt} failed:`, error.message);
                        
                        if (error.message.includes('LockManager') || error.message.includes('locks')) {
                            console.error('LockManager error detected even with polyfill - this should not happen');
                        }
                        
                        if (attempt < 3) {
                            console.log('Retrying in 1 second...');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                if (!clientCreated) {
                    throw lastError || new Error('Failed to create Supabase client after 3 attempts');
                }
                
                // Test connection
                const { data, error } = await supabase.from('customers').select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === 'PGRST116' || error.message.includes('relation "public.customers" does not exist')) {
                        // Table doesn't exist, show setup modal
                        showSetupModal();
                        return;
                    } else {
                        throw error;
                    }
                }
                
                updateSyncStatus('connected');
                setupRealtimeSubscriptions();
                
                // Load initial data
                await loadAllData();
                
                // If no data exists, set up initial sample data
                if (appData.customers.length === 0) {
                    const shouldSetup = confirm('No data found. Would you like to add sample data to get started?');
                    if (shouldSetup) {
                        await setupInitialData();
                        await loadAllData();
                    }
                }
                
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                updateSyncStatus('error');
                
                // Enhanced error handling with specific error types
                if (error.message.includes('LockManager') || error.message.includes('locks')) {
                    console.error('LockManager error occurred despite polyfill');
                    showAlert('Browser compatibility issue detected. Switching to demo mode.', 'warning');
                    testDemoMode();
                } else if (error.message.includes('Invalid API key') || error.message.includes('Project not found')) {
                    console.log('Configuration issue detected - showing setup');
                    showSetupModal();
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.log('Network issue detected');
                    showAlert('Network connection failed. Please check your internet connection.', 'error');
                    testDemoMode();
                } else if (error.message.includes('CORS')) {
                    console.log('CORS issue detected');
                    showAlert('CORS error detected. Please check your Supabase project settings.', 'error');
                    showSetupModal();
                } else {
                    console.log('Generic error - falling back to demo mode');
                    showAlert('Failed to connect to database: ' + error.message + '. Running in demo mode.', 'error');
                    testDemoMode();
                }
            }
        }
        
        function showSetupModal() {
            document.getElementById('setup-modal').style.display = 'flex';
        }
        
        function closeSetupModal() {
            document.getElementById('setup-modal').style.display = 'none';
        }
        
        function testDemoMode() {
            // Clear any existing configuration
            SUPABASE_URL = '';
            SUPABASE_ANON_KEY = '';
            supabase = null;
            
            // Use demo data when Supabase is not configured
            appData.customers = [
                {
                    id: '1',
                    name: 'Coimbatore Textiles Ltd',
                    contact_person: 'Ramesh Kumar',
                    phone: '+91-9876543210',
                    email: 'accounts@coimbatoretextiles.com',
                    address: '123 Industrial Area, Coimbatore, Tamil Nadu',
                    gst_number: '33AACC1234567Z1Z',
                    category: 'Premium',
                    credit_limit: 500000,
                    current_balance: -25000
                },
                {
                    id: '2',
                    name: 'Chennai Mills Pvt Ltd',
                    contact_person: 'Priya Sharma',
                    phone: '+91-9876543211',
                    email: 'purchase@chennaimilIs.com',
                    address: '456 Textile Complex, Chennai, Tamil Nadu',
                    gst_number: '33BBCC5678901Z2Z',
                    category: 'Regular',
                    credit_limit: 300000,
                    current_balance: 15000
                },
                {
                    id: '3',
                    name: 'Tirupur Looms',
                    contact_person: 'Suresh Babu',
                    phone: '+91-9876543212',
                    email: 'info@tirupurlooms.com',
                    address: '789 Loom Street, Tirupur, Tamil Nadu',
                    gst_number: '33CCCC9012345Z3Z',
                    category: 'Wholesale',
                    credit_limit: 200000,
                    current_balance: -50000
                }
            ];
            
            appData.transactions = [
                {
                    id: '1',
                    customer_id: '1',
                    customer: 'Coimbatore Textiles Ltd',
                    date: '2024-10-15',
                    type: 'Sale',
                    amount: 45000,
                    description: 'Picanol Air Jet Nozzle - Part No: PIC-001',
                    invoice_number: 'INV-2024-001'
                },
                {
                    id: '2',
                    customer_id: '2',
                    customer: 'Chennai Mills Pvt Ltd',
                    date: '2024-10-14',
                    type: 'Payment Received',
                    amount: -30000,
                    description: 'Payment against invoice INV-2024-002',
                    invoice_number: ''
                },
                {
                    id: '3',
                    customer_id: '3',
                    customer: 'Tirupur Looms',
                    date: '2024-10-13',
                    type: 'Sale',
                    amount: 78000,
                    description: 'Toyota Airjet Loom Reed - Model 810',
                    invoice_number: 'INV-2024-003'
                }
            ];
            
            updateSyncStatus('error');
            document.getElementById('sync-text').textContent = 'Demo Mode';
            closeSetupModal();
            showAlert('Running in demo mode. Changes will not be saved permanently.', 'warning');
            
            // Switch to dashboard and load demo data
            switchScreen('dashboard');
            loadDashboard();
        }
        
        async function setupInitialData() {
            try {
                // Insert sample customers
                const { data: customers, error: customerError } = await supabase
                    .from('customers')
                    .insert(sampleData.customers)
                    .select();
                
                if (customerError) throw customerError;
                
                // Insert sample transactions with customer references
                if (customers && customers.length > 0) {
                    const transactionsWithCustomers = sampleData.transactions.map((transaction, index) => ({
                        ...transaction,
                        customer_id: customers[index % customers.length].id
                    }));
                    
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert(transactionsWithCustomers);
                    
                    if (transactionError) throw transactionError;
                }
                
                showAlert('Initial data setup completed successfully!');
            } catch (error) {
                console.error('Error setting up initial data:', error);
                showAlert('Error setting up initial data: ' + error.message, 'error');
            }
        }
        
        async function loadAllData() {
            try {
                showLoading(true);
                
                // Load customers
                const { data: customers, error: customerError } = await supabase
                    .from('customers')
                    .select('*')
                    .order('company_name');
                
                if (customerError) throw customerError;
                
                // Load transactions with customer info
                const { data: transactions, error: transactionError } = await supabase
                    .from('transactions')
                    .select(`
                        *,
                        customers!inner(
                            id,
                            company_name
                        )
                    `)
                    .order('date', { ascending: false });
                
                if (transactionError) throw transactionError;
                
                // Process data
                appData.customers = customers.map(customer => ({
                    id: customer.id,
                    name: customer.company_name,
                    contact_person: customer.contact_person,
                    phone: customer.phone,
                    email: customer.email,
                    address: customer.address,
                    gst_number: customer.gst_number,
                    category: customer.category,
                    credit_limit: customer.credit_limit,
                    current_balance: 0 // Will be calculated from transactions
                }));
                
                appData.transactions = transactions.map(transaction => ({
                    id: transaction.id,
                    customer_id: transaction.customer_id,
                    customer: transaction.customers.company_name,
                    date: transaction.date,
                    type: transaction.type,
                    amount: transaction.amount,
                    description: transaction.description,
                    invoice_number: transaction.invoice_number
                }));
                
                // Calculate customer balances
                calculateCustomerBalances();
                
                updateSyncStatus('synced');
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateSyncStatus('error');
                showAlert('Error loading data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function calculateCustomerBalances() {
            appData.customers.forEach(customer => {
                const customerTransactions = appData.transactions.filter(t => t.customer_id === customer.id);
                customer.current_balance = customerTransactions.reduce((sum, transaction) => sum + transaction.amount, 0);
            });
        }
        
        function setupRealtimeSubscriptions() {
            // Subscribe to customers table changes
            supabase
                .channel('customers')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'customers'
                }, (payload) => {
                    console.log('Customer change received:', payload);
                    handleRealtimeCustomerChange(payload);
                })
                .subscribe();
            
            // Subscribe to transactions table changes
            supabase
                .channel('transactions')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'transactions'
                }, (payload) => {
                    console.log('Transaction change received:', payload);
                    handleRealtimeTransactionChange(payload);
                })
                .subscribe();
        }
        
        function handleRealtimeCustomerChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    const newCustomer = {
                        id: newRecord.id,
                        name: newRecord.company_name,
                        contact_person: newRecord.contact_person,
                        phone: newRecord.phone,
                        email: newRecord.email,
                        address: newRecord.address,
                        gst_number: newRecord.gst_number,
                        category: newRecord.category,
                        credit_limit: newRecord.credit_limit,
                        current_balance: 0
                    };
                    appData.customers.push(newCustomer);
                    break;
                    
                case 'UPDATE':
                    const customerIndex = appData.customers.findIndex(c => c.id === newRecord.id);
                    if (customerIndex !== -1) {
                        appData.customers[customerIndex] = {
                            ...appData.customers[customerIndex],
                            name: newRecord.company_name,
                            contact_person: newRecord.contact_person,
                            phone: newRecord.phone,
                            email: newRecord.email,
                            address: newRecord.address,
                            gst_number: newRecord.gst_number,
                            category: newRecord.category,
                            credit_limit: newRecord.credit_limit
                        };
                    }
                    break;
                    
                case 'DELETE':
                    appData.customers = appData.customers.filter(c => c.id !== oldRecord.id);
                    break;
            }
            
            // Refresh current screen
            refreshCurrentScreen();
        }
        
        function handleRealtimeTransactionChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    // Need to get customer name
                    const customer = appData.customers.find(c => c.id === newRecord.customer_id);
                    const newTransaction = {
                        id: newRecord.id,
                        customer_id: newRecord.customer_id,
                        customer: customer ? customer.name : 'Unknown Customer',
                        date: newRecord.date,
                        type: newRecord.type,
                        amount: newRecord.amount,
                        description: newRecord.description,
                        invoice_number: newRecord.invoice_number
                    };
                    appData.transactions.push(newTransaction);
                    break;
                    
                case 'UPDATE':
                    const transactionIndex = appData.transactions.findIndex(t => t.id === newRecord.id);
                    if (transactionIndex !== -1) {
                        const customer = appData.customers.find(c => c.id === newRecord.customer_id);
                        appData.transactions[transactionIndex] = {
                            ...appData.transactions[transactionIndex],
                            customer_id: newRecord.customer_id,
                            customer: customer ? customer.name : 'Unknown Customer',
                            date: newRecord.date,
                            type: newRecord.type,
                            amount: newRecord.amount,
                            description: newRecord.description,
                            invoice_number: newRecord.invoice_number
                        };
                    }
                    break;
                    
                case 'DELETE':
                    appData.transactions = appData.transactions.filter(t => t.id !== oldRecord.id);
                    break;
            }
            
            // Recalculate balances
            calculateCustomerBalances();
            
            // Refresh current screen
            refreshCurrentScreen();
        }
        
        function refreshCurrentScreen() {
            switch(currentScreen) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'outstanding':
                    loadOutstanding();
                    break;
            }
        }
        
        function updateSyncStatus(status) {
            syncStatus = status;
            const indicator = document.getElementById('sync-indicator');
            const text = document.getElementById('sync-text');
            
            indicator.className = 'sync-indicator';
            
            switch (status) {
                case 'connected':
                    text.textContent = 'Connected';
                    break;
                case 'syncing':
                    indicator.classList.add('syncing');
                    text.textContent = 'Syncing...';
                    break;
                case 'synced':
                    text.textContent = 'Synced';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    text.textContent = 'Offline';
                    break;
            }
        }
        
        function showLoading(show) {
            let overlay = document.getElementById('loading-overlay');
            
            if (show) {
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'loading-overlay';
                    overlay.className = 'loading-overlay';
                    overlay.innerHTML = '<div class="loading-spinner"></div>';
                    document.body.appendChild(overlay);
                }
                overlay.style.display = 'flex';
            } else {
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        }
        
        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 5);
        }
        
        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert--${type}`;
            alert.textContent = message;
            
            const container = document.querySelector('.main-content');
            container.insertBefore(alert, container.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-color-scheme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-color-scheme', newTheme);
            
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        // Screen Management
        function switchScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(`${screenName}-screen`).classList.add('active');
            
            // Add active to selected nav item
            event.target.closest('.nav-item').classList.add('active');
            
            currentScreen = screenName;
            
            // Load screen data
            switch(screenName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'outstanding':
                    loadOutstanding();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }
        
        // Dashboard Functions
        function loadDashboard() {
            const totalCustomers = appData.customers.length;
            const totalOutstanding = appData.customers.reduce((sum, customer) => sum + customer.current_balance, 0);
            const monthlySales = calculateMonthlySales();
            const recentTransactions = appData.transactions.length;
            
            document.getElementById('total-customers').textContent = totalCustomers;
            document.getElementById('total-outstanding').textContent = formatCurrency(totalOutstanding);
            document.getElementById('monthly-sales').textContent = formatCurrency(monthlySales);
            document.getElementById('recent-transactions').textContent = recentTransactions;
            
            loadRecentActivity();
        }
        
        function calculateMonthlySales() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            return appData.transactions
                .filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    return transactionDate.getMonth() === currentMonth && 
                           transactionDate.getFullYear() === currentYear &&
                           transaction.type === 'Sale';
                })
                .reduce((sum, transaction) => sum + Math.abs(transaction.amount), 0);
        }
        
        function loadRecentActivity() {
            const recentTransactions = appData.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const container = document.getElementById('recent-activity');
            
            if (recentTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state">No recent activity</div>';
                return;
            }
            
            container.innerHTML = recentTransactions.map(transaction => `
                <div class="transaction-card">
                    <div class="transaction-header">
                        <div>
                            <div class="customer-name">${transaction.customer}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                ${formatDate(transaction.date)} ‚Ä¢ ${transaction.type}
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.amount >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(Math.abs(transaction.amount))}
                        </div>
                    </div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                        ${transaction.description}
                    </div>
                </div>
            `).join('');
        }
        
        // Customer Functions
        function loadCustomers() {
            const container = document.getElementById('customer-list');
            
            if (appData.customers.length === 0) {
                container.innerHTML = '<div class="empty-state">No customers found</div>';
                return;
            }
            
            container.innerHTML = appData.customers.map(customer => `
                <div class="customer-card">
                    <div onclick="viewCustomerDetails('${customer.id}')" style="cursor: pointer;">
                        <div class="customer-name">${customer.name}</div>
                        <div class="customer-details">
                            <span>${customer.phone}</span>
                            <span class="balance ${customer.current_balance >= 0 ? 'positive' : 'negative'}">
                                Balance: ${formatCurrency(customer.current_balance)}
                            </span>
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-4);">
                            ${customer.category} ‚Ä¢ Credit Limit: ${formatCurrency(customer.credit_limit)}
                        </div>
                    </div>
                    <div style="margin-top: var(--space-8); padding-top: var(--space-8); border-top: 1px solid var(--color-border);">
                        <div class="btn-group">
                            <button class="btn btn--sm btn--secondary" onclick="viewCustomerDetails('${customer.id}')">Edit</button>
                            <button class="btn btn--sm btn--outline" onclick="deleteCustomer('${customer.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function viewCustomerDetails(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            currentEditingCustomer = customer;
            
            // Pre-fill form
            document.getElementById('customer-name').value = customer.name;
            document.getElementById('customer-phone').value = customer.phone;
            document.getElementById('customer-email').value = customer.email || '';
            document.getElementById('customer-address').value = customer.address || '';
            document.getElementById('customer-gst').value = customer.gst_number || '';
            document.getElementById('customer-category').value = customer.category;
            document.getElementById('customer-credit-limit').value = customer.credit_limit || '';
            
            document.getElementById('customer-modal-title').textContent = 'Edit Customer';
            document.getElementById('customer-modal').style.display = 'flex';
        }
        
        async function deleteCustomer(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            if (!confirm(`Are you sure you want to delete ${customer.name}? This will also delete all associated transactions.`)) {
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                // First delete all transactions for this customer
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .delete()
                    .eq('customer_id', customerId);
                
                if (transactionError) throw transactionError;
                
                // Then delete the customer
                const { error: customerError } = await supabase
                    .from('customers')
                    .delete()
                    .eq('id', customerId);
                
                if (customerError) throw customerError;
                
                showAlert('Customer deleted successfully');
                updateSyncStatus('synced');
                
            } catch (error) {
                console.error('Error deleting customer:', error);
                updateSyncStatus('error');
                showAlert('Error deleting customer: ' + error.message, 'error');
            }
        }
        
        function openCustomerModal() {
            currentEditingCustomer = null;
            document.getElementById('customer-form').reset();
            document.getElementById('customer-modal-title').textContent = 'Add Customer';
            document.getElementById('customer-modal').style.display = 'flex';
        }
        
        function closeCustomerModal() {
            document.getElementById('customer-modal').style.display = 'none';
            currentEditingCustomer = null;
        }
        
        async function saveCustomer() {
            const form = document.getElementById('customer-form');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const customerData = {
                company_name: document.getElementById('customer-name').value.trim(),
                contact_person: '',
                phone: document.getElementById('customer-phone').value.trim(),
                email: document.getElementById('customer-email').value.trim(),
                address: document.getElementById('customer-address').value.trim(),
                gst_number: document.getElementById('customer-gst').value.trim(),
                category: document.getElementById('customer-category').value,
                credit_limit: parseInt(document.getElementById('customer-credit-limit').value) || 0
            };
            
            // Handle demo mode
            if (!supabase || syncStatus === 'error') {
                handleDemoModeSave('customer', customerData);
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                if (currentEditingCustomer) {
                    // Update existing customer
                    const { data, error } = await supabase
                        .from('customers')
                        .update(customerData)
                        .eq('id', currentEditingCustomer.id)
                        .select();
                    
                    if (error) throw error;
                    
                    showAlert('Customer updated successfully');
                } else {
                    // Add new customer
                    const { data, error } = await supabase
                        .from('customers')
                        .insert([customerData])
                        .select();
                    
                    if (error) throw error;
                    
                    showAlert('Customer added successfully');
                }
                
                updateSyncStatus('synced');
                closeCustomerModal();
                
            } catch (error) {
                console.error('Error saving customer:', error);
                updateSyncStatus('error');
                showAlert('Error saving customer: ' + error.message, 'error');
            }
        }
        
        function handleDemoModeSave(type, data) {
            if (type === 'customer') {
                if (currentEditingCustomer) {
                    // Update existing customer
                    const index = appData.customers.findIndex(c => c.id === currentEditingCustomer.id);
                    if (index !== -1) {
                        appData.customers[index] = {
                            ...currentEditingCustomer,
                            name: data.company_name,
                            phone: data.phone,
                            email: data.email,
                            address: data.address,
                            gst_number: data.gst_number,
                            category: data.category,
                            credit_limit: data.credit_limit
                        };
                    }
                } else {
                    // Add new customer
                    const newCustomer = {
                        id: generateId(),
                        name: data.company_name,
                        contact_person: data.contact_person,
                        phone: data.phone,
                        email: data.email,
                        address: data.address,
                        gst_number: data.gst_number,
                        category: data.category,
                        credit_limit: data.credit_limit,
                        current_balance: 0
                    };
                    appData.customers.push(newCustomer);
                }
                showAlert('Customer saved (Demo Mode - changes not persistent)', 'warning');
                closeCustomerModal();
                if (currentScreen === 'customers') loadCustomers();
                updateTransactionCustomers();
            }
        }
        
        // Transaction Functions
        function loadTransactions() {
            updateTransactionCustomers();
            
            const container = document.getElementById('transaction-list');
            
            if (appData.transactions.length === 0) {
                container.innerHTML = '<div class="empty-state">No transactions found</div>';
                return;
            }
            
            const sortedTransactions = appData.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedTransactions.map(transaction => `
                <div class="transaction-card">
                    <div class="transaction-header">
                        <div>
                            <div class="customer-name">${transaction.customer}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                ${formatDate(transaction.date)} ‚Ä¢ ${transaction.type}
                                ${transaction.invoice_number ? ` ‚Ä¢ ${transaction.invoice_number}` : ''}
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.amount >= 0 ? 'positive' : 'negative'}">
                            ${transaction.amount >= 0 ? '+' : ''}${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-8);">
                        ${transaction.description}
                    </div>
                    ${transaction.type === 'Sale' && transaction.invoice_number ? `
                        <div style="margin-top: var(--space-8);">
                            <button class="btn btn--sm btn--secondary" onclick="generateInvoice('${transaction.id}')">View Invoice</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function updateTransactionCustomers() {
            const select = document.getElementById('transaction-customer');
            select.innerHTML = '<option value="">Select Customer</option>';
            
            appData.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }
        
        function openTransactionModal() {
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-modal').style.display = 'flex';
            updateTransactionCustomers();
        }
        
        function closeTransactionModal() {
            document.getElementById('transaction-modal').style.display = 'none';
        }
        
        async function saveTransaction() {
            const form = document.getElementById('transaction-form');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const customerId = document.getElementById('transaction-customer').value;
            const customer = appData.customers.find(c => c.id === customerId);
            
            if (!customer) {
                showAlert('Please select a valid customer', 'error');
                return;
            }
            
            const type = document.getElementById('transaction-type').value;
            let amount = parseFloat(document.getElementById('transaction-amount').value);
            
            // Adjust amount based on transaction type
            if (type === 'Payment Received' || type === 'Credit Note') {
                amount = -Math.abs(amount);
            } else {
                amount = Math.abs(amount);
            }
            
            const transactionData = {
                customer_id: customerId,
                date: document.getElementById('transaction-date').value,
                type: type,
                amount: amount,
                description: document.getElementById('transaction-description').value.trim(),
                invoice_number: document.getElementById('transaction-invoice').value.trim()
            };
            
            // Handle demo mode
            if (!supabase || syncStatus === 'error') {
                const newTransaction = {
                    id: generateId(),
                    customer_id: customerId,
                    customer: customer.name,
                    date: transactionData.date,
                    type: transactionData.type,
                    amount: transactionData.amount,
                    description: transactionData.description,
                    invoice_number: transactionData.invoice_number
                };
                
                appData.transactions.push(newTransaction);
                customer.current_balance += amount;
                
                showAlert('Transaction added (Demo Mode - changes not persistent)', 'warning');
                closeTransactionModal();
                
                if (currentScreen === 'transactions') loadTransactions();
                else if (currentScreen === 'dashboard') loadDashboard();
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                const { data, error } = await supabase
                    .from('transactions')
                    .insert([transactionData])
                    .select();
                
                if (error) throw error;
                
                showAlert('Transaction added successfully');
                updateSyncStatus('synced');
                closeTransactionModal();
                
            } catch (error) {
                console.error('Error saving transaction:', error);
                updateSyncStatus('error');
                showAlert('Error saving transaction: ' + error.message, 'error');
            }
        }
        
        // Outstanding Functions
        function loadOutstanding() {
            const receivable = appData.customers
                .filter(customer => customer.current_balance > 0)
                .reduce((sum, customer) => sum + customer.current_balance, 0);
            
            const payable = Math.abs(appData.customers
                .filter(customer => customer.current_balance < 0)
                .reduce((sum, customer) => sum + customer.current_balance, 0));
            
            document.getElementById('total-receivable').textContent = formatCurrency(receivable);
            document.getElementById('total-payable').textContent = formatCurrency(payable);
            
            const container = document.getElementById('outstanding-list');
            const outstandingCustomers = appData.customers.filter(customer => customer.current_balance !== 0);
            
            if (outstandingCustomers.length === 0) {
                container.innerHTML = '<div class="empty-state">No outstanding balances</div>';
                return;
            }
            
            container.innerHTML = outstandingCustomers
                .sort((a, b) => Math.abs(b.current_balance) - Math.abs(a.current_balance))
                .map(customer => {
                    const isReceivable = customer.current_balance > 0;
                    return `
                        <div class="customer-card">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-details">
                                <span>${customer.phone}</span>
                                <span class="balance ${isReceivable ? 'positive' : 'negative'}">
                                    ${isReceivable ? 'Receivable' : 'Payable'}: ${formatCurrency(Math.abs(customer.current_balance))}
                                </span>
                            </div>
                            <div style="margin-top: var(--space-8);">
                                <button class="btn btn--sm btn--primary" onclick="sendPaymentReminder('${customer.id}')">
                                    Send Reminder
                                </button>
                                <button class="btn btn--sm btn--secondary" onclick="generateCustomerStatement('${customer.id}')">
                                    View Statement
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function sendPaymentReminder(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            // In a real app, this would send an SMS/Email
            showAlert(`Payment reminder sent to ${customer.name}`);
        }
        
        function generateCustomerStatement(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const customerTransactions = appData.transactions
                .filter(t => t.customer_id === customerId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let statement = `Customer Statement: ${customer.name}\n\n`;
            statement += `Current Balance: ${formatCurrency(customer.current_balance)}\n\n`;
            statement += `Transaction History:\n`;
            
            customerTransactions.forEach(transaction => {
                statement += `${formatDate(transaction.date)} - ${transaction.type} - ${formatCurrency(transaction.amount)} - ${transaction.description}\n`;
            });
            
            // In a real app, this would generate a PDF
            alert(statement);
        }
        
        // Reports Functions
        function loadReports() {
            // Set default date range
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('report-from-date').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('report-to-date').value = today.toISOString().split('T')[0];
        }
        
        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const fromDate = document.getElementById('report-from-date').value;
            const toDate = document.getElementById('report-to-date').value;
            
            const container = document.getElementById('report-content');
            
            switch(reportType) {
                case 'customer-ledger':
                    generateCustomerLedgerReport(container, fromDate, toDate);
                    break;
                case 'outstanding-summary':
                    generateOutstandingSummaryReport(container);
                    break;
                case 'monthly-sales':
                    generateMonthlySalesReport(container, fromDate, toDate);
                    break;
                case 'transaction-history':
                    generateTransactionHistoryReport(container, fromDate, toDate);
                    break;
            }
        }
        
        function generateCustomerLedgerReport(container, fromDate, toDate) {
            container.innerHTML = `
                <div class="card">
                    <div class="card__header">
                        <h3>Customer Ledger Report</h3>
                    </div>
                    <div class="card__body">
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Category</th>
                                    <th>Current Balance</th>
                                    <th>Credit Limit</th>
                                    <th>Phone</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appData.customers.map(customer => `
                                    <tr>
                                        <td>${customer.name}</td>
                                        <td>${customer.category}</td>
                                        <td class="${customer.current_balance >= 0 ? 'positive' : 'negative'}">
                                            ${formatCurrency(customer.current_balance)}
                                        </td>
                                        <td>${formatCurrency(customer.credit_limit)}</td>
                                        <td>${customer.phone}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateOutstandingSummaryReport(container) {
            const receivableCustomers = appData.customers.filter(c => c.current_balance > 0);
            const payableCustomers = appData.customers.filter(c => c.current_balance < 0);
            
            container.innerHTML = `
                <div class="card">
                    <div class="card__header">
                        <h3>Outstanding Summary Report</h3>
                    </div>
                    <div class="card__body">
                        <div class="outstanding-summary">
                            <div class="summary-card">
                                <span class="summary-amount receivable">
                                    ${formatCurrency(receivableCustomers.reduce((sum, c) => sum + c.current_balance, 0))}
                                </span>
                                <span class="metric-label">Total Receivable</span>
                            </div>
                            <div class="summary-card">
                                <span class="summary-amount payable">
                                    ${formatCurrency(Math.abs(payableCustomers.reduce((sum, c) => sum + c.current_balance, 0)))}
                                </span>
                                <span class="metric-label">Total Payable</span>
                            </div>
                        </div>
                        
                        <h4>Receivable Details</h4>
                        <table class="invoice-table">
                            <thead>
                                <tr><th>Customer</th><th>Amount</th><th>Phone</th></tr>
                            </thead>
                            <tbody>
                                ${receivableCustomers.map(customer => `
                                    <tr>
                                        <td>${customer.name}</td>
                                        <td class="positive">${formatCurrency(customer.current_balance)}</td>
                                        <td>${customer.phone}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <h4>Payable Details</h4>
                        <table class="invoice-table">
                            <thead>
                                <tr><th>Customer</th><th>Amount</th><th>Phone</th></tr>
                            </thead>
                            <tbody>
                                ${payableCustomers.map(customer => `
                                    <tr>
                                        <td>${customer.name}</td>
                                        <td class="negative">${formatCurrency(Math.abs(customer.current_balance))}</td>
                                        <td>${customer.phone}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateMonthlySalesReport(container, fromDate, toDate) {
            const salesTransactions = appData.transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                return transactionDate >= from && transactionDate <= to && t.type === 'Sale';
            });
            
            const totalSales = salesTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            container.innerHTML = `
                <div class="card">
                    <div class="card__header">
                        <h3>Monthly Sales Report (${formatDate(fromDate)} - ${formatDate(toDate)})</h3>
                    </div>
                    <div class="card__body">
                        <div class="metric-card" style="margin-bottom: var(--space-16);">
                            <span class="metric-value">${formatCurrency(totalSales)}</span>
                            <span class="metric-label">Total Sales</span>
                        </div>
                        
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Invoice</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${salesTransactions.map(transaction => `
                                    <tr>
                                        <td>${formatDate(transaction.date)}</td>
                                        <td>${transaction.customer}</td>
                                        <td>${transaction.invoice_number || '-'}</td>
                                        <td class="positive">${formatCurrency(transaction.amount)}</td>
                                        <td>${transaction.description}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateTransactionHistoryReport(container, fromDate, toDate) {
            const filteredTransactions = appData.transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                return transactionDate >= from && transactionDate <= to;
            });
            
            container.innerHTML = `
                <div class="card">
                    <div class="card__header">
                        <h3>Transaction History Report (${formatDate(fromDate)} - ${formatDate(toDate)})</h3>
                    </div>
                    <div class="card__body">
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredTransactions.map(transaction => `
                                    <tr>
                                        <td>${formatDate(transaction.date)}</td>
                                        <td>${transaction.customer}</td>
                                        <td>${transaction.type}</td>
                                        <td class="${transaction.amount >= 0 ? 'positive' : 'negative'}">
                                            ${formatCurrency(transaction.amount)}
                                        </td>
                                        <td>${transaction.description}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function exportReport() {
            showAlert('Export functionality would be available in a full implementation');
        }
        
        // Settings Functions
        function loadSettings() {
            // Load current configuration
            const hasConfig = loadSupabaseConfig();
            
            if (hasConfig) {
                document.getElementById('supabase-url').value = SUPABASE_URL;
                document.getElementById('supabase-key').value = SUPABASE_ANON_KEY;
                updateConfigStatus('connected', 'Configuration loaded');
            } else {
                updateConfigStatus('error', 'No configuration found');
            }
            
            // Check current connection status
            checkCurrentConnection();
        }
        
        function updateConfigStatus(status, message) {
            const statusDiv = document.getElementById('connection-status');
            const indicator = document.getElementById('config-status-indicator');
            const text = document.getElementById('config-status-text');
            
            // Remove all status classes
            statusDiv.className = 'alert';
            indicator.className = 'sync-indicator';
            
            switch (status) {
                case 'connected':
                    statusDiv.classList.add('alert--success');
                    text.textContent = message;
                    break;
                case 'testing':
                    statusDiv.classList.add('alert--info');
                    indicator.classList.add('syncing');
                    text.textContent = message;
                    break;
                case 'error':
                    statusDiv.classList.add('alert--error');
                    indicator.classList.add('error');
                    text.textContent = message;
                    break;
                case 'warning':
                    statusDiv.classList.add('alert--warning');
                    text.textContent = message;
                    break;
            }
        }
        
        async function checkCurrentConnection() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                updateConfigStatus('warning', 'Please configure your Supabase connection');
                return;
            }
            
            updateConfigStatus('testing', 'Checking current connection...');
            
            try {
                const testSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { error } = await testSupabase.from('customers').select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        updateConfigStatus('warning', 'Connected but tables not created');
                        document.getElementById('auto-setup-btn').style.display = 'inline-flex';
                    } else {
                        throw error;
                    }
                } else {
                    updateConfigStatus('connected', 'Connected and ready');
                    document.getElementById('auto-setup-btn').style.display = 'none';
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                updateConfigStatus('error', 'Connection failed: ' + error.message);
            }
        }
        
        async function testConnection() {
            const urlInput = document.getElementById('supabase-url');
            const keyInput = document.getElementById('supabase-key');
            const testBtn = document.getElementById('test-btn');
            
            const url = urlInput.value.trim();
            const key = keyInput.value.trim();
            
            // Validate inputs
            if (!url || !key) {
                showAlert('Please enter both URL and API key', 'error');
                return;
            }
            
            if (!url.match(/^https:\/\/.*\.supabase\.co$/)) {
                showAlert('Please enter a valid Supabase URL', 'error');
                urlInput.focus();
                return;
            }
            
            if (!key.startsWith('eyJ')) {
                showAlert('API key appears to be invalid. It should start with "eyJ"', 'error');
                keyInput.focus();
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            updateConfigStatus('testing', 'Testing connection...');
            
            try {
                console.log('Testing connection with enhanced error handling...');
                
                // Test the connection with retry mechanism
                let testSupabase = null;
                let connectionSuccessful = false;
                
                for (let attempt = 1; attempt <= 2; attempt++) {
                    try {
                        console.log(`Connection test attempt ${attempt}/2`);
                        
                        // Create test client with minimal options to avoid issues
                        testSupabase = window.supabase.createClient(url, key, {
                            auth: {
                                persistSession: false,
                                autoRefreshToken: false
                            },
                            realtime: {
                                enabled: false // Disable realtime for test
                            }
                        });
                        
                        connectionSuccessful = true;
                        console.log('Test client created successfully');
                        break;
                        
                    } catch (createError) {
                        console.warn(`Test client creation attempt ${attempt} failed:`, createError);
                        
                        if (createError.message.includes('LockManager')) {
                            console.error('LockManager error in test - polyfill may not be working');
                            throw new Error('Browser compatibility issue detected. The polyfill did not resolve the LockManager error. Please try using Chrome or Edge browser.');
                        }
                        
                        if (attempt < 2) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        } else {
                            throw createError;
                        }
                    }
                }
                
                if (!connectionSuccessful || !testSupabase) {
                    throw new Error('Failed to create test client');
                }
                
                // Try to connect and check if we can access the database
                const { error } = await testSupabase.from('customers').select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === 'PGRST116' || error.message.includes('relation "public.customers" does not exist')) {
                        updateConfigStatus('warning', 'Connection successful! Database tables need to be created.');
                        document.getElementById('auto-setup-btn').style.display = 'inline-flex';
                        showAlert('Connection test successful! Your database is ready for setup.', 'success');
                    } else if (error.message.includes('Invalid API key') || error.message.includes('Project not found')) {
                        throw new Error('Invalid credentials. Please check your URL and API key.');
                    } else {
                        throw error;
                    }
                } else {
                    updateConfigStatus('connected', 'Connection successful! Database is ready.');
                    document.getElementById('auto-setup-btn').style.display = 'none';
                    showAlert('Connection test successful! Your database is ready to use.', 'success');
                }
                
                // Enable save button
                document.getElementById('save-btn').disabled = false;
                
            } catch (error) {
                console.error('Connection test failed:', error);
                
                let errorMessage = error.message;
                let userFriendlyMessage = errorMessage;
                
                // Provide specific guidance based on error type
                if (error.message.includes('LockManager')) {
                    userFriendlyMessage = 'Browser compatibility issue: Locks API not available. Please try Chrome or Edge browser, or switch to demo mode.';
                    updateConfigStatus('error', 'Browser compatibility issue detected');
                } else if (error.message.includes('Invalid API key') || error.message.includes('Project not found')) {
                    userFriendlyMessage = 'Invalid credentials. Please check your Supabase URL and API key.';
                    updateConfigStatus('error', 'Invalid credentials');
                } else if (error.message.includes('CORS')) {
                    userFriendlyMessage = 'CORS error. Please check your Supabase project settings and ensure the domain is allowed.';
                    updateConfigStatus('error', 'CORS policy issue');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    userFriendlyMessage = 'Network error. Please check your internet connection and try again.';
                    updateConfigStatus('error', 'Network connection failed');
                } else {
                    updateConfigStatus('error', 'Connection failed: ' + errorMessage);
                }
                
                showAlert('Connection test failed: ' + userFriendlyMessage, 'error');
                document.getElementById('save-btn').disabled = true;
                
                // Add helpful tips
                if (error.message.includes('LockManager')) {
                    setTimeout(() => {
                        showAlert('Tip: Try using Chrome/Edge browser or switch to demo mode for testing.', 'warning');
                    }, 2000);
                }
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Connection';
            }
        }
        
        function saveConfiguration() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                showAlert('Please test the connection first', 'error');
                return;
            }
            
            if (saveSupabaseConfig(url, key)) {
                showAlert('Configuration saved for this session!', 'success');
                
                // Reinitialize Supabase with new config
                setTimeout(async () => {
                    await initializeSupabase();
                    updateSyncStatus('connected');
                }, 1000);
            }
        }
        
        function clearConfiguration() {
            if (confirm('Are you sure you want to clear the database configuration? This will reset for this session only.')) {
                try {
                    // Clear in-memory configuration
                    supabaseConfig = null;
                    SUPABASE_URL = '';
                    SUPABASE_ANON_KEY = '';
                    supabase = null;
                    
                    // Clear form fields if on settings screen
                    const urlInput = document.getElementById('supabase-url');
                    const keyInput = document.getElementById('supabase-key');
                    if (urlInput) urlInput.value = '';
                    if (keyInput) keyInput.value = '';
                    
                    const saveBtn = document.getElementById('save-btn');
                    const autoSetupBtn = document.getElementById('auto-setup-btn');
                    if (saveBtn) saveBtn.disabled = true;
                    if (autoSetupBtn) autoSetupBtn.style.display = 'none';
                    
                    updateConfigStatus('warning', 'Configuration cleared');
                    updateSyncStatus('error');
                    document.getElementById('sync-text').textContent = 'Not Configured';
                    
                    showAlert('Configuration cleared successfully (session only)', 'success');
                } catch (error) {
                    showAlert('Error clearing configuration: ' + error.message, 'error');
                }
            }
        }
        
        function showDatabaseSetup() {
            const modal = document.getElementById('setup-modal');
            modal.style.display = 'flex';
        }
        
        async function autoSetupDatabase() {
            if (!supabase) {
                showAlert('Please save configuration first', 'error');
                return;
            }
            
            const autoSetupBtn = document.getElementById('auto-setup-btn');
            autoSetupBtn.disabled = true;
            autoSetupBtn.textContent = 'Setting up...';
            updateConfigStatus('testing', 'Creating database tables...');
            
            try {
                // Create customers table
                const { error: customersError } = await supabase.rpc('exec_sql', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS customers (
                          id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                          company_name TEXT NOT NULL,
                          contact_person TEXT,
                          phone TEXT,
                          email TEXT,
                          address TEXT,
                          gst_number TEXT,
                          category TEXT DEFAULT 'Regular',
                          credit_limit NUMERIC DEFAULT 0,
                          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                    `
                });
                
                // Create transactions table
                const { error: transactionsError } = await supabase.rpc('exec_sql', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS transactions (
                          id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                          customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
                          date DATE NOT NULL,
                          type TEXT NOT NULL,
                          amount NUMERIC NOT NULL,
                          description TEXT NOT NULL,
                          invoice_number TEXT,
                          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                    `
                });
                
                // If RPC method doesn't exist, user needs to create tables manually
                if (customersError || transactionsError) {
                    throw new Error('Auto-setup not available. Please create tables manually using the SQL editor.');
                }
                
                updateConfigStatus('connected', 'Database setup completed successfully!');
                showAlert('Database tables created successfully!', 'success');
                document.getElementById('auto-setup-btn').style.display = 'none';
                
                // Initialize with sample data
                const shouldAddSample = confirm('Would you like to add sample data to get started?');
                if (shouldAddSample) {
                    await setupInitialData();
                    await loadAllData();
                }
                
            } catch (error) {
                console.error('Auto-setup failed:', error);
                updateConfigStatus('warning', 'Auto-setup failed. Please use manual setup.');
                showAlert('Auto-setup failed: ' + error.message + '. Please use the manual SQL setup.', 'warning');
                showDatabaseSetup();
            } finally {
                autoSetupBtn.disabled = false;
                autoSetupBtn.textContent = 'Auto-Setup Database';
            }
        }
        
        function exportData() {
            try {
                const data = {
                    customers: appData.customers,
                    transactions: appData.transactions,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `rkm-loom-spares-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                showAlert('Data exported successfully', 'success');
            } catch (error) {
                showAlert('Export failed: ' + error.message, 'error');
            }
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.customers || !data.transactions) {
                        throw new Error('Invalid data format');
                    }
                    
                    if (confirm('This will replace all current data. Continue?')) {
                        // In a real app, you would sync this to Supabase
                        appData.customers = data.customers;
                        appData.transactions = data.transactions;
                        showAlert('Data imported successfully (demo mode)', 'success');
                        refreshCurrentScreen();
                    }
                } catch (error) {
                    showAlert('Import failed: ' + error.message, 'error');
                }
            };
            input.click();
        }
        
        function switchToDemo() {
            if (confirm('Switch to demo mode? This will use sample data and changes will not be saved.')) {
                testDemoMode();
                showAlert('Switched to demo mode', 'warning');
            }
        }
        
        // Browser Compatibility Functions
        function runBrowserCompatibilityTest() {
            console.log('Running browser compatibility test...');
            
            const results = {
                userAgent: navigator.userAgent,
                isSecureContext: browserInfo.isSecureContext,
                hasLocks: browserInfo.hasLocks,
                hasIndexedDB: browserInfo.hasIndexedDB,
                hasBroadcastChannel: browserInfo.hasBroadcastChannel,
                locksPolyfillApplied: !browserInfo.hasLocks && ('locks' in navigator),
                webWorkerSupport: 'Worker' in window,
                fetchSupport: 'fetch' in window,
                promiseSupport: 'Promise' in window,
                asyncAwaitSupport: true // We're using it, so it must be supported
            };
            
            // Test if polyfills are working
            try {
                const testLocks = navigator.locks.request('test-lock', () => {
                    return Promise.resolve('locks working');
                });
                results.locksApiWorking = true;
            } catch (error) {
                results.locksApiWorking = false;
                results.locksError = error.message;
            }
            
            updateBrowserStatus(results);
            
            // Show detailed results
            const compatibilityLevel = calculateCompatibilityLevel(results);
            let message = `Browser Compatibility: ${compatibilityLevel}\n\n`;
            
            if (compatibilityLevel === 'Excellent') {
                message += 'Your browser fully supports all features.';
            } else if (compatibilityLevel === 'Good') {
                message += 'Your browser supports most features with polyfills.';
            } else if (compatibilityLevel === 'Limited') {
                message += 'Some features may not work. Consider using Chrome or Edge.';
            } else {
                message += 'This browser has significant limitations. Demo mode recommended.';
            }
            
            alert(message);
            console.log('Browser compatibility results:', results);
        }
        
        function updateBrowserStatus(results = null) {
            const statusDiv = document.getElementById('browser-status');
            if (!statusDiv) return;
            
            const currentResults = results || {
                isSecureContext: browserInfo.isSecureContext,
                hasLocks: browserInfo.hasLocks,
                locksPolyfillApplied: !browserInfo.hasLocks && ('locks' in navigator),
                hasIndexedDB: browserInfo.hasIndexedDB
            };
            
            statusDiv.innerHTML = `
                <div>üîí Secure Context: ${currentResults.isSecureContext ? '‚úÖ Yes' : '‚ùå No (HTTPS required)'}</div>
                <div>üîê Locks API: ${currentResults.hasLocks ? '‚úÖ Native' : (currentResults.locksPolyfillApplied ? 'üîß Polyfilled' : '‚ùå Not Available')}</div>
                <div>üíæ IndexedDB: ${currentResults.hasIndexedDB ? '‚úÖ Available' : '‚ùå Not Available'}</div>
                <div>üì° Network Status: ${isOnline ? '‚úÖ Online' : '‚ùå Offline'}</div>
            `;
        }
        
        function calculateCompatibilityLevel(results) {
            let score = 0;
            
            if (results.isSecureContext) score += 2;
            if (results.locksApiWorking) score += 2;
            if (results.hasIndexedDB) score += 1;
            if (results.hasBroadcastChannel) score += 1;
            if (results.webWorkerSupport) score += 1;
            if (results.fetchSupport) score += 1;
            
            if (score >= 7) return 'Excellent';
            if (score >= 5) return 'Good';
            if (score >= 3) return 'Limited';
            return 'Poor';
        }
        
        // Invoice Functions
        function generateInvoice(transactionId) {
            const transaction = appData.transactions.find(t => t.id === transactionId);
            if (!transaction || transaction.type !== 'Sale') return;
            
            const customer = appData.customers.find(c => c.id === transaction.customer_id);
            if (!customer) return;
            
            const invoiceContent = `
                <div class="invoice-header">
                    <h1>${appData.company.name}</h1>
                    <p>${appData.company.address}</p>
                    <p>Phone: ${appData.company.phone} | Email: ${appData.company.email}</p>
                    <p>GST: ${appData.company.gst_number}</p>
                </div>
                
                <div class="invoice-details">
                    <div>
                        <h4>Bill To:</h4>
                        <p><strong>${customer.name}</strong></p>
                        <p>${customer.address}</p>
                        <p>Phone: ${customer.phone}</p>
                        <p>GST: ${customer.gst_number || 'N/A'}</p>
                    </div>
                    <div style="text-align: right;">
                        <h4>Invoice Details:</h4>
                        <p><strong>Invoice #:</strong> ${transaction.invoice_number}</p>
                        <p><strong>Date:</strong> ${formatDate(transaction.date)}</p>
                        <p><strong>Due Date:</strong> ${formatDate(new Date(Date.now() + 30*24*60*60*1000))}</p>
                    </div>
                </div>
                
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${transaction.description}</td>
                            <td>1</td>
                            <td>${formatCurrency(transaction.amount)}</td>
                            <td>${formatCurrency(transaction.amount)}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="invoice-total">
                    <p><strong>Total Amount: ${formatCurrency(transaction.amount)}</strong></p>
                </div>
                
                <div style="margin-top: var(--space-24); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                    <p><strong>Terms &amp; Conditions:</strong></p>
                    <p>1. Payment due within 30 days of invoice date</p>
                    <p>2. All disputes must be raised within 7 days</p>
                    <p>3. Subject to Tamil Nadu jurisdiction</p>
                </div>
            `;
            
            document.getElementById('invoice-preview').innerHTML = invoiceContent;
            document.getElementById('invoice-modal').style.display = 'flex';
        }
        
        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }
        
        function printInvoice() {
            window.print();
        }
        
        // Search Functions
        function setupSearchHandlers() {
            document.getElementById('customer-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterCustomers(searchTerm);
            });
            
            document.getElementById('transaction-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterTransactions(searchTerm);
            });
        }
        
        function filterCustomers(searchTerm) {
            const filteredCustomers = appData.customers.filter(customer =>
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.phone.toLowerCase().includes(searchTerm) ||
                customer.email.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('customer-list');
            
            if (filteredCustomers.length === 0) {
                container.innerHTML = '<div class="empty-state">No customers found</div>';
                return;
            }
            
            container.innerHTML = filteredCustomers.map(customer => `
                <div class="customer-card">
                    <div onclick="viewCustomerDetails('${customer.id}')" style="cursor: pointer;">
                        <div class="customer-name">${customer.name}</div>
                        <div class="customer-details">
                            <span>${customer.phone}</span>
                            <span class="balance ${customer.current_balance >= 0 ? 'positive' : 'negative'}">
                                Balance: ${formatCurrency(customer.current_balance)}
                            </span>
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-4);">
                            ${customer.category} ‚Ä¢ Credit Limit: ${formatCurrency(customer.credit_limit)}
                        </div>
                    </div>
                    <div style="margin-top: var(--space-8); padding-top: var(--space-8); border-top: 1px solid var(--color-border);">
                        <div class="btn-group">
                            <button class="btn btn--sm btn--secondary" onclick="viewCustomerDetails('${customer.id}')">Edit</button>
                            <button class="btn btn--sm btn--outline" onclick="deleteCustomer('${customer.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filterTransactions(searchTerm) {
            const filteredTransactions = appData.transactions.filter(transaction =>
                transaction.customer.toLowerCase().includes(searchTerm) ||
                transaction.description.toLowerCase().includes(searchTerm) ||
                transaction.invoice_number.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('transaction-list');
            
            if (filteredTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state">No transactions found</div>';
                return;
            }
            
            const sortedTransactions = filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedTransactions.map(transaction => `
                <div class="transaction-card">
                    <div class="transaction-header">
                        <div>
                            <div class="customer-name">${transaction.customer}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                ${formatDate(transaction.date)} ‚Ä¢ ${transaction.type}
                                ${transaction.invoice_number ? ` ‚Ä¢ ${transaction.invoice_number}` : ''}
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.amount >= 0 ? 'positive' : 'negative'}">
                            ${transaction.amount >= 0 ? '+' : ''}${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-8);">
                        ${transaction.description}
                    </div>
                    ${transaction.type === 'Sale' && transaction.invoice_number ? `
                        <div style="margin-top: var(--space-8);">
                            <button class="btn btn--sm btn--secondary" onclick="generateInvoice('${transaction.id}')">View Invoice</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Network status management
        function setupNetworkListeners() {
            window.addEventListener('online', () => {
                isOnline = true;
                updateSyncStatus('connected');
                showAlert('Back online! Syncing data...', 'success');
                loadAllData();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateSyncStatus('error');
                showAlert('You are now offline. Changes will sync when connection is restored.', 'warning');
            });
        }
        
        // Initialize Application
        async function initializeApp() {
            console.log('Initializing RKM LOOM SPARES application...');
            console.log('Browser compatibility info:', browserInfo);
            
            // Set initial theme based on system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-color-scheme', 'dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
            
            // Setup network listeners
            setupNetworkListeners();
            
            // Initialize Supabase and load data
            await initializeSupabase();
            
            // Load initial screen based on configuration status
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                // If no configuration, show settings screen
                setTimeout(() => {
                    showAlert('Welcome! Please configure your database connection in Settings.', 'info');
                }, 1000);
                loadDashboard(); // Still load dashboard but with limited functionality
            } else {
                loadDashboard();
            }
            
            // Setup search handlers
            setupSearchHandlers();
            
            // Update browser status in settings if visible
            updateBrowserStatus();
            
            // Setup service worker for PWA functionality
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript;charset=utf-8;base64,Ly8gU2ltcGxlIFNlcnZpY2UgV29ya2VyIGZvciBQV0EgZnVuY3Rpb25hbGl0eQpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBldmVudCA9PiB7CiAgY29uc29sZS5sb2coJ1NlcnZpY2UgV29ya2VyIGluc3RhbGxlZCcpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBldmVudCA9PiB7CiAgLy8gU2ltcGxlIGZldGNoIGhhbmRsZXIgZm9yIG9mZmxpbmUgZnVuY3Rpb25hbGl0eQogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7');
            }
            
            console.log('Application initialization complete');
        }
        
        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>